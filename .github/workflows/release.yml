name: Release on Main

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    steps:
      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3Ô∏è‚É£ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4Ô∏è‚É£ Extract release version
      - name: Extract release version
        id: extract_version
        run: |
          MERGE_BRANCH=$(git log -1 --pretty=format:'%s' | sed -n 's/Merge pull request #[0-9]\+ from .*release\/\([0-9]\+\.[0-9]\+\.[0-9]\+\).*/\1/p')
          VERSION=${MERGE_BRANCH:-0.0.0}
          echo "Release version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # 5Ô∏è‚É£ Generate CHANGELOG & Tag
      - name: Generate CHANGELOG & Tag
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          if [[ "$VERSION" == "0.0.0" ]]; then
            echo "‚ùå No valid release branch detected. Exiting."
            exit 1
          fi

          npm run release -- --release-as $VERSION

          sed -i -E "s/versionName \"[0-9]+\.[0-9]+\.[0-9]+\"/versionName \"$VERSION\"/" app/build.gradle

          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          git add CHANGELOG.md package.json package-lock.json app/build.gradle || true
          git commit -m "chore(release): release $VERSION" || echo "No changes to commit"
          git push origin main --follow-tags

      # 6Ô∏è‚É£ Auto-create PR from main ‚Üí develop
      - name: Create PR from main to develop
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: develop
          branch: main
          title: "Sync main to develop after release"
          body: |
            üîÑ Auto PR: Sync `main` branch changes into `develop` after release ${{ steps.extract_version.outputs.version }}.
